<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Mapa de Grupos</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    html, body { margin: 0; padding: 0; height: 100%; }
    #map { height: 100vh; width: 100%; }

    /* Painel do formul√°rio (recolh√≠vel) */
    #formulario {
      position: absolute;
      top: 50px;
      left: 50px;
      width: 180px;
      z-index: 1000;
      background: white;
      padding: 10px;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0,0,0,0.3);
      display: none; /* come√ßa recolhido */
    }

    #formulario input {
      width: 163px;
      padding: 6px;
      margin-bottom: 6px;
      display: block;
    }

    #formulario button {
      width: 100%;
      padding: 6px 10px;
      margin-bottom: 6px;
      background: #1976d2;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }

    #formulario button:hover { background: #125a9c; }

    /* Bot√£o flutuante para abrir/recolher o painel */
   #toggleMenu {
  position: absolute;
  top: 10px; /* abaixo do controle de zoom */
  left: 50px;
  z-index: 1100;
  background: #1976d2;
  color: white;
  border: none;
  border-radius: 5px;
  padding: 6px 10px;
  cursor: pointer;
}


    #toggleMenu:hover { background: #125a9c; }
	
	@media (max-width: 600px) {
  #formulario {
    width: 90vw;
    left: 5vw;
    top: 60px;
    padding: 12px;
  }

  #formulario input,
  #formulario button {
    width: 100%;
    font-size: 16px;
  }

  #toggleMenu {
    top: 10px;
    left: 10px;
    font-size: 16px;
    padding: 8px 12px;
  }
}

  </style>
</head>
<body>
  <!-- Bot√£o para abrir/recolher o painel -->
  <button id="toggleMenu">‚ò∞ Menu</button>

  <!-- Painel de formul√°rio -->
  <div id="formulario">
    <!-- Login do administrador -->
    <input type="email" id="emailAdmin" placeholder="Email do administrador" />
    <input type="password" id="senhaAdmin" placeholder="Senha" />
    <button id="btnEntrar" onclick="fazerLogin()">üîê Entrar</button>

    <!-- Formul√°rio de grupos -->
    <input type="text" id="nomeGrupo" placeholder="Nome do Grupo" />
    <input type="text" id="enderecoGrupo" placeholder="Endere√ßo completo" />
    <button id="btnAdicionar" onclick="ativarModoAdicionar()" disabled>Adicionar ou Editar Grupo</button>
    <button id="btnExportar" onclick="exportarCSV()" disabled>üì§ Exportar para Excel</button>
    <input type="text" id="buscaGrupo" placeholder="Buscar grupo por nome" />
	<button onclick="mostrarMinhaLocalizacao()">üìç Minha localiza√ß√£o</button>
	<button onclick="contarGruposPorRegiao()">üìä Contar grupos por regi√£o</button>

    <!-- Filtrar Grupos Por Categoria -->
<select id="filtroCategoria" onchange="filtrarGruposPorCategoria()">
  <option value="">‚Äî Filtrar por bairro ‚Äî</option>
  <option value="Zona 1">Zona 1</option>
  <option value="Zona 7">Zona 7</option>
  <option value="Jardim Alvorada">Jardim Alvorada</option>
  <option value="Regi√£o desconhecida">Regi√£o desconhecida</option>
</select>
	
  </div>

  <div id="map"></div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

  <!-- Script n√£o-m√≥dulo: utilidades e fun√ß√µes globais -->
  <script>
    // Alterna exibi√ß√£o do painel
    document.getElementById("toggleMenu").addEventListener("click", () => {
      const painel = document.getElementById("formulario");
      painel.style.display = (painel.style.display === "none") ? "block" : "none";
    });

    // Utilit√°rio para busca sem acento
    function removerAcentos(str) {
      return str.normalize("NFD").replace(/[\u0300-\u036f]/g, "");
    }

    // Estado global
    window.adminLogado = false;
    window.modoAdicionar = false;
    window.grupoEditando = null;
    window.todosMarcadores = [];

    // A√ß√µes dependentes de permiss√£o
    window.ativarModoAdicionar = () => {
      if (!window.adminLogado) return alert("Somente administradores podem adicionar ou editar.");
      window.modoAdicionar = true;
      alert("Modo de adi√ß√£o/edi√ß√£o ativado. Clique no mapa para definir a posi√ß√£o.");
    };

    window.editarGrupo = (id, nome, endereco) => {
      if (!window.adminLogado) return alert("Somente administradores podem editar.");
      document.getElementById("nomeGrupo").value = nome;
      document.getElementById("enderecoGrupo").value = endereco;
      window.modoAdicionar = true;
      window.grupoEditando = id;
      alert("Modo edi√ß√£o ativado. Clique no novo local no mapa.");
    };

    window.excluirGrupo = async (id) => {
      if (!window.adminLogado) return alert("Somente administradores podem excluir.");
      const { getDatabase, ref, remove } = await import("https://www.gstatic.com/firebasejs/12.2.1/firebase-database.js");
      const db = getDatabase();
      await remove(ref(db, 'grupos/' + id));
      alert("Grupo exclu√≠do");
      location.reload();
    };

    // Busca por nome
    window.buscarGrupo = (nomeBuscado) => {
      const nome = (nomeBuscado || "").trim();
      if (!nome) return;
      const nomeLimpo = removerAcentos(nome.toLowerCase());
      const grupo = window.todosMarcadores.find(m => removerAcentos((m.nome || "").toLowerCase()).includes(nomeLimpo));
      if (grupo) {
        grupo.marker.openPopup();
        grupo.marker._map.setView([grupo.lat, grupo.lng], 16);
      } else {
        alert("Grupo n√£o encontrado.");
      }
    };

    document.getElementById("buscaGrupo").addEventListener("keypress", function(e) {
      if (e.key === "Enter") {
        const nome = e.target.value.trim();
        if (nome) buscarGrupo(nome);
      }
    });

    // Exporta√ß√£o CSV (apenas admin)
    window.exportarCSV = () => {
      if (!window.adminLogado) return alert("Somente administradores podem exportar os dados.");
      const grupos = window.todosMarcadores || [];
      if (grupos.length === 0) return alert("Nenhum grupo para exportar.");

      const linhas = [["Nome", "Endere√ßo", "Latitude", "Longitude"]];
      grupos.forEach(g => {
        // Extrai endere√ßo do popup (2¬™ linha)
        const popup = g.marker.getPopup()?.getContent() || "";
        const endereco = popup.split("<br>")[1]?.trim() || "";
        linhas.push([g.nome, endereco, g.lat, g.lng]);
      });

      const csv = linhas
        .map(l => l.map(v => `"${String(v).replace(/"/g, '""')}"`).join(","))
        .join("\n");

      const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
      const link = document.createElement("a");
      link.href = URL.createObjectURL(blob);
      link.download = "grupos.csv";
      link.click();
    };
	
	window.mostrarMinhaLocalizacao = () => {
  if (!navigator.geolocation) {
    alert("Geolocaliza√ß√£o n√£o √© suportada neste navegador.");
    return;
  }

  navigator.geolocation.getCurrentPosition(
    (pos) => {
      const lat = pos.coords.latitude;
      const lng = pos.coords.longitude;

      const marcador = L.marker([lat, lng], { icon: L.icon({
        iconUrl: "https://cdn-icons-png.flaticon.com/512/64/64113.png",
        iconSize: [25, 25],
        iconAnchor: [12, 25]
      }) }).addTo(map)
        .bindPopup("üìç Voc√™ est√° aqui").openPopup();

      map.setView([lat, lng], 16);
    },
    (err) => {
      alert("N√£o foi poss√≠vel obter sua localiza√ß√£o.");
      console.error(err);
    }
  );
};

function extrairBairro(endereco) {
  const partes = endereco.split(",");
  return partes.length >= 2 ? partes[1].trim() : "Regi√£o desconhecida";
}

window.filtrarGruposPorCategoria = () => {
  const filtro = document.getElementById("filtroCategoria").value;
  const grupos = window.todosMarcadores || [];

  grupos.forEach(g => {
    const popup = g.marker.getPopup()?.getContent() || "";
    const endereco = popup.split("<br>")[1]?.trim() || "";
    const bairro = extrairBairro(endereco);

    if (!filtro || bairro === filtro) {
      g.marker.addTo(g.marker._map);
    } else {
      g.marker.remove();
    }
  });
};

function coletarBairrosUnicos() {
  const setBairros = new Set();
  (window.todosMarcadores || []).forEach(g => {
    const popup = g.marker.getPopup()?.getContent() || "";
    const endereco = popup.split("<br>")[1]?.trim() || "";
    const bairro = extrairBairro(endereco);
    setBairros.add(bairro);
  });
  return Array.from(setBairros).sort((a, b) => a.localeCompare(b, 'pt-BR'));
}

  </script>

  <!-- Script principal (m√≥dulo) com Firebase -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-auth.js";
    import { getDatabase, ref, set, get, child } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDpXPkobIHUvWHPijM3J8VXPrILyIFti6A",
      authDomain: "gpslocalsbackend.firebaseapp.com",
      databaseURL: "https://gpslocalsbackend-default-rtdb.firebaseio.com",
      projectId: "gpslocalsbackend",
      storageBucket: "gpslocalsbackend.appspot.com",
      messagingSenderId: "587842449786",
      appId: "1:587842449786:web:2a41f86212057feacc66c3"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const auth = getAuth(app);

    // Login exposto no escopo global
    window.fazerLogin = async () => {
      const email = document.getElementById("emailAdmin").value.trim();
      const senha = document.getElementById("senhaAdmin").value.trim();
      if (!email || !senha) return alert("Preencha email e senha");

      try {
        await signInWithEmailAndPassword(auth, email, senha);
        // onAuthStateChanged tratar√° o restante
      } catch (error) {
        alert("Login inv√°lido. Verifique email e senha.");
      }
    };

    // Observa login/logout e ajusta UI
    onAuthStateChanged(auth, (user) => {
      const btnEntrar = document.getElementById("btnEntrar");
      if (user) {
        window.adminLogado = true;
        document.getElementById("btnAdicionar").disabled = false;
        document.getElementById("btnExportar").disabled = false;
        btnEntrar.textContent = "Sair";
        btnEntrar.onclick = async () => { await signOut(auth); };
      } else {
        window.adminLogado = false;
        document.getElementById("btnAdicionar").disabled = true;
        document.getElementById("btnExportar").disabled = true;
        btnEntrar.textContent = "üîê Entrar";
        btnEntrar.onclick = () => window.fazerLogin();
      }
    });

    // Inicializa mapa
    const map = L.map('map').setView([-23.6629, -52.6057], 14);
    window.map = map; // deixa o mapa acess√≠vel para outras fun√ß√µes
	
    const mapaPadrao = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '¬© OpenStreetMap'
    });

    const mapaSatelite = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
      attribution: '¬© Esri & contributors'
    });

    mapaSatelite.addTo(map);

    L.control.layers({
      "Mapa Padr√£o": mapaPadrao,
      "Sat√©lite": mapaSatelite
    }).addTo(map);

    // Clique no mapa para adicionar/editar
    map.on('click', async function(e) {
      if (!window.adminLogado || !window.modoAdicionar) return;

      const nome = document.getElementById("nomeGrupo").value.trim();
      const endereco = document.getElementById("enderecoGrupo").value.trim();
      if (!nome || !endereco) return alert("Preencha o nome e o endere√ßo");

      const lat = e.latlng.lat;
      const lng = e.latlng.lng;
      const id = window.grupoEditando || Date.now();

      await set(ref(db, 'grupos/' + id), { nome, endereco, lat, lng });

      // Se estava editando, sincroniza com reload simples
      if (window.grupoEditando) {
        alert("Grupo atualizado.");
        window.modoAdicionar = false;
        window.grupoEditando = null;
        location.reload();
        return;
      }

      // Adiciona novo marcador
      const marker = L.marker([lat, lng]).addTo(map)
        .bindTooltip(nome, { permanent: true, direction: 'top', offset: [0, -10] })
        .bindPopup(`
          <strong>${nome}</strong><br>${endereco}<br><br>
          <button onclick="editarGrupo('${id}', '${String(nome).replace(/'/g, "\\'")}', '${String(endereco).replace(/'/g, "\\'")}')">‚úèÔ∏è Editar</button>
          <button onclick="excluirGrupo('${id}')">üóëÔ∏è Excluir</button>
        `);

      window.todosMarcadores.push({ nome, lat, lng, marker });

      window.modoAdicionar = false;
      window.grupoEditando = null;
      alert("Grupo adicionado.");
    });

    // Carrega grupos existentes
    get(child(ref(db), 'grupos')).then(snapshot => {
      if (snapshot.exists()) {
        const grupos = snapshot.val();
        Object.entries(grupos).forEach(([id, g]) => {
          const marker = L.marker([g.lat, g.lng]).addTo(map)
            .bindTooltip(g.nome, { permanent: true, direction: 'top', offset: [0, -10] })
            .bindPopup(`
              <strong>${g.nome}</strong><br>${g.endereco}<br><br>
              <button onclick="editarGrupo('${id}', '${String(g.nome).replace(/'/g, "\\'")}', '${String(g.endereco).replace(/'/g, "\\'")}')">‚úèÔ∏è Editar</button>
              <button onclick="excluirGrupo('${id}')">üóëÔ∏è Excluir</button>
            `);

          window.todosMarcadores.push({ nome: g.nome, lat: g.lat, lng: g.lng, marker });
        });
      }
    });
	window.contarGruposPorRegiao = () => {
  const grupos = window.todosMarcadores || [];
  const contagem = {};

  grupos.forEach(g => {
    const endereco = g.marker.getPopup()?.getContent()?.split("<br>")[1]?.trim() || "";
    const bairro = extrairBairro(endereco); // fun√ß√£o que voc√™ pode adaptar
    contagem[bairro] = (contagem[bairro] || 0) + 1;
  });

  let texto = "üìä Grupos por regi√£o:\n\n";
  Object.entries(contagem).forEach(([bairro, total]) => {
    texto += `‚Ä¢ ${bairro}: ${total}\n`;
  });

  alert(texto);
};

  </script>
</body>
</html>
